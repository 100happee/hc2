<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>HappeeChat2</title>
<link rel="icon" href="https://i1.sndcdn.com/avatars-V22Gw2FsnsI9xMuU-ihNrRA-t240x240.jpg" />
<!-- Poppins font -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0b0e12;
    --panel:#0f1419;
    --muted:#8b97a6;
    --accent:#4da3ff;
    --contrast:#12161a;
    --bubble:#0e1317;
    --mention:#f5d35b;
    --mention-text:#1a1a1a;
    --max-width:1200px;
    font-family: 'Poppins', sans-serif;
  }
  html,body{height:100%;margin:0;background:linear-gradient(180deg,#071017 0%, #04060a 100%);color:#e6eef6}
  .app {
    max-width:var(--max-width);
    margin:18px auto;
    height:88vh;
    display:flex;
    gap:12px;
    border-radius:12px;
    overflow:hidden;
    box-shadow:0 10px 30px rgba(0,0,0,0.6);
  }
  .middle {
    width:260px;
    background:var(--panel);
    padding:12px;
    display:flex;
    flex-direction:column;
    gap:8px;
    box-sizing:border-box;
  }
  .chat-list {overflow:auto;flex:1;padding-top:6px}
  .chat-item {display:flex;gap:8px;align-items:center;padding:8px;border-radius:8px;cursor:pointer}
  .chat-item:hover{background:rgba(255,255,255,0.02)}
  .chat-item img {width:44px;height:44px;border-radius:8px;object-fit:cover}
  .chat-item .meta {display:flex;flex-direction:column}
  .chat-item .meta .name {font-weight:600}
  .unread-count {margin-left:auto;background:#2b6aab;padding:4px 6px;border-radius:6px;font-size:12px}
  .right {
    flex:1;
    background:linear-gradient(180deg,var(--contrast),#081017);
    display:flex;flex-direction:column;padding:12px;box-sizing:border-box;
  }
  .header {display:flex;align-items:center;gap:12px;padding-bottom:8px;border-bottom:1px solid rgba(255,255,255,0.02);}
  .header .title {font-size:18px;font-weight:700}
  .header .controls {margin-left:auto;display:flex;gap:8px;align-items:center}
  .btn {background:var(--accent);color:#06121a;padding:8px 12px;border-radius:8px;border:none;cursor:pointer;font-weight:600}
  .btn.ghost{background:transparent;color:var(--accent);border:1px solid rgba(255,255,255,0.04)}
  .read-btn{background:#334153;color:white;padding:6px 8px;border-radius:8px}
  .volume {display:flex;align-items:center;gap:8px}
  .volume input[type=range]{width:120px}
  .messages {flex:1;overflow:auto;padding:12px;display:flex;flex-direction:column;gap:12px}
  .message {display:flex;gap:12px;align-items:flex-start;padding:8px;border-radius:8px;background:transparent;transition:background 120ms}
  .message:hover{background:rgba(255,255,255,0.01)}
  .message .avatar {width:48px;height:48px;border-radius:8px;object-fit:cover}
  .message .body {flex:1}
  .message .meta {display:flex;gap:8px;align-items:center}
  .message .username{font-weight:700}
  .message .text{margin-top:6px;white-space:pre-wrap}
  .message .timestamp{font-size:11px;color:var(--muted);margin-left:auto}
  .mentioned {background:linear-gradient(90deg,#3b2b03,#5a4710);border-radius:8px}
  .file-embed {margin-top:8px;border-radius:8px;overflow:hidden;border:1px solid rgba(255,255,255,0.03);padding:6px;background:#070a0c}
  .input-row {display:flex;gap:8px;align-items:center;padding-top:8px;border-top:1px solid rgba(255,255,255,0.02)}
  .input-row textarea{flex:1;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:inherit;min-height:44px;max-height:120px;resize:none}
  .input-row .add-btn{width:44px;height:44px;border-radius:8px;border:1px dashed rgba(255,255,255,0.03);display:flex;align-items:center;justify-content:center;cursor:pointer}
  .small {font-size:12px;color:var(--muted)}
  .login-overlay{position:absolute;inset:0;background:linear-gradient(180deg, rgba(3,6,9,0.6), rgba(3,6,9,0.9));display:flex;align-items:center;justify-content:center;z-index:9999}
  .login-box{width:420px;background:linear-gradient(180deg,#07101a,#081218);padding:20px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);display:flex;flex-direction:column;gap:16px;box-sizing:border-box}
  .login-section{display:flex;flex-direction:column;gap:8px}
  .account img{width:48px;height:48px;border-radius:8px;object-fit:cover}
  input,button,select,textarea{font-family:inherit}
  .danger{background:#ff6b6b;color:white}
  .admin-delete {margin-left:auto;background:#7b2634;color:#fff;padding:6px;border-radius:8px;border:none;cursor:pointer}
  @media(max-width:900px){.middle{display:none}.login-box{width:94%}}
</style>
</head>
<body>
<div style="position:relative">
  <div class="app" id="app">
    <!-- Middle (chats) -->
    <div class="middle">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <div style="font-weight:700">Chats</div>
        <div class="small" id="online-count">0 online</div>
      </div>
      <div class="chat-list" id="chat-list"></div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="create-group-btn" class="btn ghost small" style="flex:1">+ Make Group DM</button>
      </div>
    </div>

    <!-- Right (messages) -->
    <div class="right">
      <div class="header">
        <div class="title" id="chat-title">Public Chat</div>
        <div class="controls" id="header-controls">
          <div class="small">Ping vol</div>
          <div class="volume"><input id="volume-slider" type="range" min="0" max="100" value="70"/></div>
          <button id="read-messages" class="read-btn small">Read Messages</button>
          <button id="logout" class="btn ghost small">Logout</button>
        </div>
      </div>
      <div class="messages" id="messages"></div>
      <div class="input-row">
        <label class="add-btn" title="Attach file" id="attach-btn">+</label>
        <input type="file" id="file-input" style="display:none" />
        <textarea id="txt-message" placeholder="Write a message..."></textarea>
        <button id="send-btn" class="btn">Send Message</button>
      </div>
    </div>
  </div>

  <!-- Login overlay -->
  <div class="login-overlay" id="login-overlay">
    <div class="login-box">
      <!-- Create Account -->
      <div class="login-section">
        <div style="font-weight:700">Create New Account</div>
        <input id="new-username" placeholder="username (unique)" />
        <input id="new-password" type="password" placeholder="password" />
        <div style="display:flex;gap:8px;align-items:center">
          <input id="avatar-file" type="file" accept="image/*" />
          <div id="avatar-preview" style="width:48px;height:48px;border-radius:8px;background:rgba(255,255,255,0.02);display:flex;align-items:center;justify-content:center">avatar</div>
        </div>
        <button id="create-account" class="btn">Create Account</button>
      </div>

      <!-- Log In -->
      <div class="login-section">
        <div style="font-weight:700">Log In</div>
        <input id="login-username" placeholder="username" />
        <input id="login-password" type="password" placeholder="password" />
        <button id="login-btn" class="btn">Log In</button>
        <div class="small">Log into an account used in the past 7 days</div>
      </div>

      <!-- Google login -->
      <button id="google-login" class="btn" style="margin-top:8px;background:#fff;color:#000">Sign in with Google</button>

      <div id="login-msg" class="small" style="margin-top:8px;color:var(--muted)"></div>
    </div>
  </div>
</div>

<!-- ping sound -->
<audio id="ping-audio" src="./ping.mp3" preload="auto"></audio>

<!-- Firebase SDKs -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
import { getDatabase, ref, onValue, set, push, remove, get, update } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";

/* Firebase config */
const firebaseConfig = {
  apiKey: "AIzaSyDkpDlINFiUzR0PsFRcxxk-N2fhHLnpACI",
  authDomain: "hchat2-1d004.firebaseapp.com",
  databaseURL: "https://hchat2-1d004-default-rtdb.firebaseio.com",
  projectId: "hchat2-1d004",
  storageBucket: "hchat2-1d004.firebasestorage.app",
  messagingSenderId: "807685526215",
  appId: "1:807685526215:web:6b9042099ff0b464be24e2"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);
const googleProvider = new GoogleAuthProvider();

/* state */
let state = { me:null, selectedChat:"public", usersCache:{}, groupsCache:{}, messagesCache:{}, unread:{}, pingVolume:0.7 };
const el=(s)=>document.querySelector(s);

/* DOM refs */
const loginOverlay=el('#login-overlay');
const createBtn=el('#create-account');
const loginBtn=el('#login-btn');
const googleBtn=el('#google-login');
const avatarFile=el('#avatar-file');
const avatarPreview=el('#avatar-preview');
const newUsername=el('#new-username');
const newPassword=el('#new-password');
const loginUsername=el('#login-username');
const loginPassword=el('#login-password');
const loginMsg=el('#login-msg');
const logoutBtn=el('#logout');
const chatList=el('#chat-list');
const messagesArea=el('#messages');
const chatTitle=el('#chat-title');
const txtMessage=el('#txt-message');
const sendBtn=el('#send-btn');
const fileInput=el('#file-input');
const attachBtn=el('#attach-btn');
const readMessagesBtn=el('#read-messages');
const volumeSlider=el('#volume-slider');
const pingAudio=el('#ping-audio');
const onlineCount=el('#online-count');
const headerControls=el('#header-controls');
const createGroupBtn=el('#create-group-btn');
const groupModal=el('#group-modal'); // placeholder if groups modal kept

let avatarBase64ForCreate=null;

/* utils */
function uid(){return 'id_'+Math.random().toString(36).slice(2,9);}
function defaultAvatar(name){const letter=(name||'?').charAt(0).toUpperCase();return `https://via.placeholder.com/80/222229/ffffff?text=${encodeURIComponent(letter)}`;}
function fileToBase64(file){return new Promise((res,rej)=>{const r=new FileReader();r.onload=()=>res(r.result);r.onerror=()=>rej('err');r.readAsDataURL(file);});}

/* Avatar preview */
avatarFile.addEventListener('change',async(ev)=>{const f=ev.target.files[0];if(!f)return;if(f.size>4*1024*1024){alert("Avatar too big");return;}const b=await fileToBase64(f);avatarBase64ForCreate=b;avatarPreview.innerHTML=`<img src="${b}" style="width:48px;height:48px;border-radius:8px;object-fit:cover"/>`;});

/* Create account */
createBtn.addEventListener('click',async()=>{
  const username=(newUsername.value||"").trim();
  const password=newPassword.value||"";
  if(!username||!password){loginMsg.textContent="Enter username and password.";return;}
  const fakeEmail=username+"@happee.fake";
  try{
    const cred=await createUserWithEmailAndPassword(auth,fakeEmail,password);
    const userId=cred.user.uid;
    const userObj={username,avatar:avatarBase64ForCreate||defaultAvatar(username),createdAt:Date.now(),lastActive:Date.now(),deleted:false};
    await set(ref(db,'users/'+userId),userObj);
    loginMsg.textContent="Account created. You can now log in.";
  }catch(err){loginMsg.textContent=err.message;}
});

/* Login with email/pw */
loginBtn.addEventListener('click',async()=>{
  const username=(loginUsername.value||"").trim();
  const password=loginPassword.value||"";
  if(!username||!password){loginMsg.textContent="Enter username and password.";return;}
  const fakeEmail=username+"@happee.fake";
  try{
    const cred=await signInWithEmailAndPassword(auth,fakeEmail,password);
    const snap=await get(ref(db,'users/'+cred.user.uid));
    const u=snap.val();
    state.me={id:cred.user.uid,username:u.username,avatar:u.avatar};
    loginOverlay.style.display='none';
    afterLogin();
  }catch(err){alert("Login failed: "+err.message);}
});

/* Google login */
googleBtn.addEventListener('click',async()=>{
  try{
    const result=await signInWithPopup(auth,googleProvider);
    const user=result.user;
    const snap=await get(ref(db,'users/'+user.uid));
    if(!snap.exists()){
      const userObj={username:user.displayName||user.email.split('@')[0],avatar:user.photoURL||defaultAvatar(user.displayName),createdAt:Date.now(),lastActive:Date.now(),deleted:false};
      await set(ref(db,'users/'+user.uid),userObj);
    }
    state.me={id:user.uid,username:user.displayName||user.email,avatar:user.photoURL};
    loginOverlay.style.display='none';
    afterLogin();
  }catch(err){alert("Google login failed: "+err.message);}
});

/* Logout */
logoutBtn.addEventListener('click',()=>{signOut(auth).then(()=>{state.me=null;loginOverlay.style.display='flex';});});

/* After login placeholder (reuse your existing logic) */
async function afterLogin(){
  // TODO: hook up your existing fetchUsersAndRender(), fetchGroupsAndListen(), listenMessages(), etc
  chatTitle.textContent="Public Chat";
}

/* Start with login overlay open */
loginOverlay.style.display='flex';
</script>
</body>
</html>
