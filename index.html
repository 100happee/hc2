<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>HappeeChat2</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
<link rel="icon" href="https://i1.sndcdn.com/avatars-V22Gw2FsnsI9xMuU-ihNrRA-t240x240.jpg">
<style>
  /* Basic reset */
  * {margin:0;padding:0;box-sizing:border-box;font-family:'Poppins',sans-serif;}
  body {background:#121212;color:#eee;overflow:hidden;}
  .hidden{display:none;}
  /* Login screen */
  #loginScreen {position:absolute;top:0;left:0;width:100%;height:100%;background:#1e1e1e;display:flex;justify-content:center;align-items:center;flex-direction:row;gap:50px;padding:20px;}
  #existingUsers, #createAccount {background:#2a2a2a;padding:20px;border-radius:12px;width:300px;height:80%;overflow-y:auto;}
  #existingUsers h2,#createAccount h2{margin-bottom:10px;text-align:center;}
  .userCard {display:flex;align-items:center,gap:10px;padding:5px;margin:5px 0;background:#333;border-radius:8px;cursor:pointer;}
  .userCard img {width:40px;height:40px;border-radius:50%;}
  .userCard span {margin-left:10px;}
  /* Chat UI */
  #chatUI {display:flex;height:100vh;width:100vw;}
  #leftBar {width:80px;background:#1f1f1f;padding:10px;display:flex;flex-direction:column;gap:10px;overflow-y:auto;}
  #leftBar button {width:60px;height:60px;border:none;border-radius:10px;background:#333;color:#fff;font-size:24px;cursor:pointer;position:relative;}
  #leftBar button .unread {position:absolute;top:-5px;right:-5px;background:red;color:#fff;font-size:12px;border-radius:50%;padding:2px 5px;}
  #mainChat {flex:1;display:flex;flex-direction:column;}
  #messageList {flex:1;overflow-y:auto;padding:10px;}
  .message {padding:5px 10px;margin-bottom:5px;border-radius:8px;display:flex;gap:10px;align-items:flex-start;transition:background 0.2s;}
  .message:hover {background:#2a2a2a;}
  .message .avatar {width:40px;height:40px;border-radius:50%;}
  .message .content {flex:1;}
  .message .content .username {font-weight:600;}
  .message .content .timestamp {font-size:10px;color:#aaa;margin-left:5px;}
  .message .content .text a{color:#4da3ff;text-decoration:underline;}
  .message.mention{background:#555500;}
  .message.mention .text .at{color:#3399ff;}
  #messageInput {display:flex;padding:10px;background:#1e1e1e;}
  #messageInput input[type=text]{flex:1;padding:10px;border-radius:8px;border:none;background:#333;color:#fff;margin-right:5px;}
  #messageInput button{padding:10px;border:none;border-radius:8px;background:#4da3ff;color:#fff;cursor:pointer;}
  #fileInput{display:none;}
  #pingVolume {position:absolute;top:10px;right:10px;}
  #readMessages{position:absolute;top:50px;right:10px;padding:5px 10px;background:#4da3ff;color:#fff;border:none;border-radius:8px;cursor:pointer;}
</style>
</head>
<body>

<!-- Login Screen -->
<div id="loginScreen">
  <div id="existingUsers">
    <h2>Existing Users</h2>
    <div id="userList"></div>
  </div>
  <div id="createAccount">
    <h2>Create Account</h2>
    <input type="text" id="newUsername" placeholder="Username"><br><br>
    <input type="password" id="newPassword" placeholder="Password"><br><br>
    <input type="file" id="newAvatar"><br><br>
    <button id="createAccountBtn">Create Account</button>
  </div>
</div>

<!-- Chat UI -->
<div id="chatUI" class="hidden">
  <div id="leftBar">
    <button id="publicChatBtn">#<span class="unread hidden" id="publicUnread">0</span></button>
    <div id="dmList"></div>
  </div>
  <div id="mainChat">
    <div id="messageList"></div>
    <div id="messageInput">
      <button id="fileBtn">+</button>
      <input type="text" id="messageText" placeholder="Type a message">
      <button id="sendMessageBtn">Send</button>
      <input type="file" id="fileInput">
    </div>
  </div>
</div>

<audio id="pingSound" src="ping.mp3"></audio>
<input type="range" id="pingVolume" min="0" max="1" step="0.01" value="0.5">
<button id="readMessages">Read Messages</button>

<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-app.js";
import { getDatabase, ref, set, push, onValue, remove, get } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-database.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyDkpDlINFiUzR0PsFRcxxk-N2fhHLnpACI",
  authDomain: "hchat2-1d004.firebaseapp.com",
  databaseURL: "https://hchat2-1d004-default-rtdb.firebaseio.com",
  projectId: "hchat2-1d004",
  storageBucket: "hchat2-1d004.firebasestorage.app",
  messagingSenderId: "807685526215",
  appId: "1:807685526215:web:6b9042099ff0b464be24e2"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// State
let currentUser = null;
let currentChat = 'public';
let users = {};
let blacklist = ['badword']; // add words here
let messageLimit = 500;

// Utilities
function escapeHTML(text){return text.replace(/[&<>"']/g,function(m){return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m];});}
function replaceBlacklist(text){let r=text;blacklist.forEach(w=>{let re=new RegExp('\\b'+w+'\\b','gi');r=r.replace(re,'*'.repeat(w.length));});return r;}
function formatTime(ts){let d=new Date(ts);let h=d.getHours()%12||12;let ampm=d.getHours()>=12?'p':'a';return `[${d.getMonth()+1}/${d.getDate()} at ${h}:${d.getMinutes().toString().padStart(2,'0')}${ampm}]`;}

// Login
const userListDiv = document.getElementById('userList');
const dmListDiv = document.getElementById('dmList');
const loginScreen = document.getElementById('loginScreen');
const chatUI = document.getElementById('chatUI');

function loadUsers(){
  const usersRef = ref(db,'users/');
  onValue(usersRef,(snapshot)=>{
    users = snapshot.val()||{};
    renderUserList();
    renderDMList();
  });
}
function renderUserList(){
  userListDiv.innerHTML='';
  Object.keys(users).forEach(u=>{
    const user=users[u];
    if(user.deleted) return;
    const div=document.createElement('div');
    div.className='userCard';
    div.innerHTML=`<img src="${user.avatar||'https://i.pravatar.cc/40'}"><span>${u}</span>`;
    div.onclick=()=>loginPrompt(u);
    userListDiv.appendChild(div);
  });
}
function loginPrompt(username){
  const pass=prompt('Enter password for '+username);
  if(!pass) return;
  const stored=users[username].password;
  if(stored===pass){
    currentUser=username;
    loginScreen.classList.add('hidden');
    chatUI.classList.remove('hidden');
    loadMessages();
  }else{
    alert('Incorrect password');
  }
}

// Create account
document.getElementById('createAccountBtn').onclick=async()=>{
  const u=document.getElementById('newUsername').value.trim();
  const p=document.getElementById('newPassword').value;
  if(!u||!p){alert('Username/password required');return;}
  if(users[u]){alert('Username exists');return;}
  let avatar=null;
  const file=document.getElementById('newAvatar').files[0];
  if(file){
    avatar=await fileToBase64(file);
  }
  set(ref(db,'users/'+u),{password:p,avatar:avatar,lastActive:Date.now()});
  document.getElementById('newUsername').value='';document.getElementById('newPassword').value='';
  document.getElementById('newAvatar').value='';
};

// File to Base64
function fileToBase64(file){
  return new Promise((res,rej)=>{
    const reader=new FileReader();
    reader.onload=()=>res(reader.result);
    reader.onerror=err=>rej(err);
    reader.readAsDataURL(file);
  });
}

// Messaging
const messageList = document.getElementById('messageList');
const msgInput = document.getElementById('messageText');
const sendBtn = document.getElementById('sendMessageBtn');
const fileInput = document.getElementById('fileInput');
const fileBtn = document.getElementById('fileBtn');
const pingSound = document.getElementById('pingSound');
const pingVolume = document.getElementById('pingVolume');

pingVolume.oninput=()=>pingSound.volume=pingVolume.value;
fileBtn.onclick=()=>fileInput.click();

sendBtn.onclick=sendMessage;
msgInput.addEventListener('keypress',e=>{if(e.key==='Enter') sendMessage();});

async function sendMessage(){
  let text=msgInput.value.trim();
  if(!text && !fileInput.files.length) return;
  text=replaceBlacklist(text);
  let attachments=[];
  for(const f of fileInput.files){
    if(f.size>4*1024*1024){alert('File too big');continue;}
    attachments.push({name:f.name,data:await fileToBase64(f)});
  }
  const msg={sender:currentUser,text,text,timestamp:Date.now(),attachments};
  push(ref(db,'messages/'+currentChat),msg);
  msgInput.value='';fileInput.value='';
}

// Load messages
function loadMessages(){
  const msgsRef = ref(db,'messages/'+currentChat);
  onValue(msgsRef,(snapshot)=>{
    const msgs=snapshot.val()||{};
    messageList.innerHTML='';
    const sorted = Object.values(msgs).sort((a,b)=>a.timestamp-b.timestamp).slice(-messageLimit);
    sorted.forEach(m=>{
      const div=document.createElement('div');
      div.className='message';
      if(m.text.includes('@'+currentUser)) div.classList.add('mention');
      let attachmentsHTML='';
      m.attachments?.forEach(a=>{
        if(a.data.startsWith('data:image')) attachmentsHTML+=`<img src="${a.data}" style="max-width:200px;display:block;margin-top:5px;">`;
        else if(a.data.startsWith('data:video')) attachmentsHTML+=`<video controls src="${a.data}" style="max-width:200px;margin-top:5px;"></video>`;
        else if(a.data.startsWith('data:audio')) attachmentsHTML+=`<audio controls src="${a.data}" style="margin-top:5px;"></audio>`;
        else attachmentsHTML+=`<a href="${a.data}" download="${a.name}">${a.name}</a>`;
      });
      let textWithLinks = m.text.replace(/https:\/\/[^\s]+/g,link=>`<a href="${link}" target="_blank">${link}</a>`);
      textWithLinks=textWithLinks.replace(/@(\w+)/g,'<span class="at">@$1</span>');
      div.innerHTML=`<img class="avatar" src="${users[m.sender]?.avatar||'https://i.pravatar.cc/40'}">
      <div class="content"><span class="username">${m.sender}</span> <span class="timestamp">${formatTime(m.timestamp)}</span>
      <div class="text">${textWithLinks}${attachmentsHTML}</div></div>`;
      messageList.appendChild(div);
    });
    messageList.scrollTop=messageList.scrollHeight;
    pingSound.play();
  });
}

// DMs
function renderDMList(){
  dmListDiv.innerHTML='';
  Object.keys(users).forEach(u=>{
    if(u===currentUser || users[u].deleted) return;
    const btn=document.createElement('button');
    btn.textContent=u[0].toUpperCase();
    btn.onclick=()=>{currentChat='dm_'+[currentUser,u].sort().join('_');loadMessages();};
    dmListDiv.appendChild(btn);
  });
}

// Read messages
document.getElementById('readMessages').onclick=()=>document.title='HappeeChat2';

// Auto deletion
setInterval(()=>{
  const now=Date.now();
  Object.entries(users).forEach(([u,d])=>{
    if(d.deleted) return;
    if(now-d.lastActive>30*24*3600*1000 && u!=='100happee'){remove(ref(db,'users/'+u));}
  });
  ['public',...Object.keys(users).filter(u=>u!==currentUser).map(u=>'dm_'+[currentUser,u].sort().join('_'))].forEach(chat=>{
    const chatRef = ref(db,'messages/'+chat);
    get(chatRef).then(snapshot=>{
      const msgs=snapshot.val()||{};
      Object.entries(msgs).forEach(([k,m])=>{
        if(now-m.timestamp>7*24*3600*1000) remove(ref(db,'messages/'+chat+'/'+k));
      });
    });
  });
},60*1000); // every 1 min

loadUsers();
</script>
</body>
</html>
