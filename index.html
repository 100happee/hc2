<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>HappeeChat2</title>
  <style>
    body {
      margin: 0;
      font-family: 'Poppins', sans-serif;
      background-color: #2b2d31;
      color: #ddd;
      overflow: hidden;
    }
    #loginScreen, #chatScreen {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
    }
    #loginScreen {
      background: #1e1f22;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    #accountsList {
      display: flex;
      flex-direction: column;
      max-height: 300px;
      overflow-y: auto;
      margin-bottom: 1em;
    }
    .accountItem {
      display: flex;
      align-items: center;
      background: #2b2d31;
      padding: 0.5em;
      border-radius: 8px;
      cursor: pointer;
      margin: 0.25em 0;
    }
    .accountItem img {
      width: 32px; height: 32px; border-radius: 50%; margin-right: 0.5em;
    }
    #chatScreen { display: none; flex-direction: row; height: 100%; }
    #sidebar {
      width: 70px;
      background: #1e1f22;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 0.5em 0;
      overflow-y: auto;
    }
    .chatOption {
      width: 50px; height: 50px;
      margin: 0.5em 0;
      background: #2b2d31;
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer;
      position: relative;
    }
    .chatOption img { width: 32px; height: 32px; border-radius: 50%; }
    .chatOption .unread {
      position: absolute;
      bottom: 0; right: 0;
      background: red; color: white;
      font-size: 10px;
      padding: 2px 4px;
      border-radius: 10px;
    }
    #messagesArea {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: #313338;
    }
    #messagesLog {
      flex: 1;
      overflow-y: auto;
      padding: 1em;
    }
    .message {
      padding: 0.25em;
      margin: 0.25em 0;
      border-radius: 6px;
      transition: background 0.2s;
    }
    .message:hover { background: #3c3f44; }
    .mention { color: #4da3ff; }
    .mentionHighlight { background: #665500; }
    .message .meta { font-size: 0.7em; color: #aaa; }
    #inputBar {
      display: flex;
      padding: 0.5em;
      background: #2b2d31;
    }
    #inputBar input[type="text"] {
      flex: 1;
      padding: 0.5em;
      border: none;
      border-radius: 6px;
      margin: 0 0.5em;
      background: #404249;
      color: white;
    }
    #inputBar button, #inputBar input[type="file"] {
      background: #5865f2;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 0.5em;
      cursor: pointer;
    }
    #topBar {
      background: #2b2d31;
      padding: 0.5em;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    #volumeSlider { width: 100px; }
    #readMessagesBtn { background: #4da3ff; border:none; padding:0.3em 0.6em; border-radius:6px; cursor:pointer;}
    .deleteBtn {
      color: red; cursor: pointer; font-size: 0.7em; margin-left: 0.5em;
    }
  </style>
</head>
<body>
  <div id="loginScreen">
    <h1>HappeeChat2</h1>
    <div id="accountsList"></div>
    <button onclick="showCreateAccount()">Create Account</button>
    <div id="createAccountForm" style="display:none; flex-direction:column; align-items:center;">
      <input id="newUsername" placeholder="Username">
      <input id="newPassword" type="password" placeholder="Password">
      <input id="newAvatar" type="file" accept="image/*">
      <button onclick="createAccount()">Submit</button>
    </div>
  </div>

  <div id="chatScreen">
    <div id="sidebar"></div>
    <div id="messagesArea">
      <div id="topBar">
        <button id="readMessagesBtn" onclick="markAllRead()">Read Messages</button>
        <input id="volumeSlider" type="range" min="0" max="1" step="0.1" value="1">
      </div>
      <div id="messagesLog"></div>
      <div id="inputBar">
        <input id="fileInput" type="file" style="display:none" onchange="sendFile(this.files[0])">
        <button onclick="document.getElementById('fileInput').click()">+</button>
        <input id="msgInput" type="text" placeholder="Message">
        <button onclick="sendMessage()">Send</button>
      </div>
    </div>
  </div>

  <audio id="pingSound" src="ping.mp3"></audio>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getDatabase, ref, set, push, onChildAdded, onValue, remove, update } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";
    import { getStorage, ref as sRef, uploadString, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDkpDlINFiUzR0PsFRcxxk-N2fhHLnpACI",
      authDomain: "hchat2-1d004.firebaseapp.com",
      databaseURL: "https://hchat2-1d004-default-rtdb.firebaseio.com",
      projectId: "hchat2-1d004",
      storageBucket: "hchat2-1d004.appspot.com",
      messagingSenderId: "807685526215",
      appId: "1:807685526215:web:6b9042099ff0b464be24e2"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const storage = getStorage(app);

    let currentUser = null;
    let currentChat = "public";
    let volume = 1;
    let unreadCount = 0;
    const blacklist = ["badword1","badword2"]; // put words here

    function showCreateAccount(){ document.getElementById('createAccountForm').style.display='flex'; }

    function createAccount(){
      const username = document.getElementById('newUsername').value;
      const password = document.getElementById('newPassword').value;
      const file = document.getElementById('newAvatar').files[0];
      if(!username || !password) return alert("Missing fields");
      const usersRef = ref(db, "users/"+username);
      onValue(usersRef, snap=>{
        if(snap.exists()){ alert("Username exists"); return; }
        if(file){
          const reader = new FileReader();
          reader.onload = e=>{
            set(usersRef, { password: password, avatar: e.target.result, lastActive: Date.now() });
          };
          reader.readAsDataURL(file);
        } else {
          set(usersRef, { password: password, avatar: "", lastActive: Date.now() });
        }
        document.getElementById('createAccountForm').style.display='none';
      }, {onlyOnce:true});
    }

    const accountsList = document.getElementById('accountsList');
    onValue(ref(db,"users"), snap=>{
      accountsList.innerHTML="";
      snap.forEach(child=>{
        const u=child.key, d=child.val();
        if(!d) return;
        const div=document.createElement('div');
        div.className="accountItem";
        div.innerHTML=`<img src="${d.avatar||''}"><span>${u}</span>`;
        div.onclick=()=>{
          const pw=prompt("Password for "+u);
          if(pw===d.password){ login(u,d); } else alert("Wrong password");
        };
        accountsList.appendChild(div);
      });
    });

    function login(u,d){
      currentUser={username:u, avatar:d.avatar};
      document.getElementById('loginScreen').style.display="none";
      document.getElementById('chatScreen').style.display="flex";
      updateSidebar();
      loadMessages();
    }

    function updateSidebar(){
      const sidebar=document.getElementById('sidebar');
      sidebar.innerHTML="";
      // public chat option
      const publicOpt=document.createElement('div');
      publicOpt.className="chatOption";
      publicOpt.innerHTML="#";
      publicOpt.onclick=()=>{currentChat="public"; loadMessages();};
      sidebar.appendChild(publicOpt);
      // users
      onValue(ref(db,"users"), snap=>{
        snap.forEach(child=>{
          const uname=child.key, d=child.val();
          if(!d) return;
          if(uname===currentUser.username) return;
          const opt=document.createElement('div');
          opt.className="chatOption";
          opt.innerHTML=`<img src="${d.avatar}">`;
          opt.onclick=()=>{currentChat=uname; loadMessages();};
          sidebar.appendChild(opt);
        });
      });
    }

    function loadMessages(){
      const log=document.getElementById('messagesLog');
      log.innerHTML="";
      const path = currentChat==="public" ? "messages/public" : "dms/"+chatKey(currentUser.username,currentChat);
      onValue(ref(db,path), snap=>{
        log.innerHTML="";
        let count=0;
        snap.forEach(c=>{
          const m=c.val();
          if(!m) return;
          count++;
          if(count>500 && currentChat==="public"){ remove(ref(db,path+"/"+c.key)); return; }
          renderMessage(m,c.key);
        });
      });
    }

    function renderMessage(m,id){
      const log=document.getElementById('messagesLog');
      const div=document.createElement('div');
      div.className="message";
      let content = sanitize(m.text);
      blacklist.forEach(w=>{ 
        const re=new RegExp(w,"gi"); 
        content=content.replace(re,"*".repeat(w.length));
      });
      let mentionHighlight="";
      if(content.includes("@"+currentUser.username)){div.classList.add("mentionHighlight");}
      const ytMatch=content.match(/https:\/\/youtu\.be\/[A-Za-z0-9_-]+|https:\/\/www\.youtube\.com\/watch\?v=[A-Za-z0-9_-]+/);
      if(ytMatch){
        const url=ytMatch[0];
        const vidId = url.includes("youtu.be")?url.split("/").pop():new URL(url).searchParams.get("v");
        content+=`<br><iframe width="300" height="200" src="https://www.youtube.com/embed/${vidId}" frameborder="0" allowfullscreen></iframe>`;
      }
      div.innerHTML=`<img src="${m.avatar}" style="width:24px;height:24px;border-radius:50%;vertical-align:middle;"> <b>${m.user}</b>: ${content} <span class="meta">[${m.time}]</span>`;
      if(currentUser.username==="100happee" || currentUser.username===m.user){
        const del=document.createElement('span');
        del.className="deleteBtn";
        del.innerText="delete";
        del.onclick=()=>{ remove(ref(db,(currentChat==="public"?"messages/public":"dms/"+chatKey(currentUser.username,currentChat))+"/"+id)); };
        div.appendChild(del);
      }
      log.appendChild(div);
      log.scrollTop=log.scrollHeight;
    }

    function sendMessage(){
      const text=document.getElementById('msgInput').value;
      if(!text) return;
      const now=new Date();
      const ts=`${now.getMonth()+1}/${now.getDate()} at ${now.getHours()}:${now.getMinutes()}`;
      const path=currentChat==="public"?"messages/public":"dms/"+chatKey(currentUser.username,currentChat);
      push(ref(db,path),{user:currentUser.username,avatar:currentUser.avatar,text:text,time:ts});
      document.getElementById('msgInput').value="";
      playPing();
    }

    function sendFile(file){
      if(!file) return;
      if(file.size>4*1024*1024){ alert("File too big"); return; }
      const reader=new FileReader();
      reader.onload=e=>{
        const base64=e.target.result;
        const now=new Date();
        const ts=`${now.getMonth()+1}/${now.getDate()} at ${now.getHours()}:${now.getMinutes()}`;
        const path=currentChat==="public"?"messages/public":"dms/"+chatKey(currentUser.username,currentChat);
        push(ref(db,path),{user:currentUser.username,avatar:currentUser.avatar,text:`<a href="${base64}" download="${file.name}">${file.name}</a>`,time:ts});
      };
      reader.readAsDataURL(file);
    }

    function chatKey(u1,u2){ return [u1,u2].sort().join("_"); }

    function playPing(){ const ping=document.getElementById('pingSound'); ping.volume=volume; ping.play(); }

    document.getElementById('volumeSlider').oninput=e=>{ volume=e.target.value; };

    function markAllRead(){ unreadCount=0; document.title="HappeeChat2"; }

    function sanitize(s){ return s.replace(/(https:\/\/[^\s]+)/g,'<a href="$1" target="_blank">$1</a>'); }

    // auto delete old messages and idle users
    setInterval(()=>{
      const now=Date.now();
      // messages >7d
      ["messages/public","dms"].forEach(path=>{
        onValue(ref(db,path),(snap)=>{
          snap.forEach(c=>{
            const m=c.val();
            if(!m) return;
            if(m.timestamp && now-m.timestamp>7*24*60*60*1000){ remove(ref(db,path+"/"+c.key)); }
          });
        },{onlyOnce:true});
      });
      // idle users >30d
      onValue(ref(db,"users"),snap=>{
        snap.forEach(c=>{
          const u=c.key, d=c.val();
          if(u==="100happee") return;
          if(d.lastActive && now-d.lastActive>30*24*60*60*1000){ remove(ref(db,"users/"+u)); }
        });
      },{onlyOnce:true});
    },60000);

  </script>
</body>
</html>
