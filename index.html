<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>HappeeChat2</title>
<link rel="icon" href="https://i1.sndcdn.com/avatars-V22Gw2FsnsI9xMuU-ihNrRA-t240x240.jpg">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<style>
  body {
    margin: 0;
    font-family: 'Poppins', sans-serif;
    background-color: #121212;
    color: #eee;
    overflow: hidden;
  }
  #loginScreen, #chatScreen { position: absolute; top:0; left:0; width:100%; height:100%; }
  #loginScreen { display:flex; align-items:center; justify-content:center; flex-direction:column; background-color:#1e1e1e; z-index:10; }
  .account { display:flex; align-items:center; margin:5px; cursor:pointer; padding:5px; border-radius:5px; background:#2c2c2c; }
  .account img { width:40px; height:40px; border-radius:50%; margin-right:10px; }
  .btn { padding:5px 10px; margin:5px; cursor:pointer; border:none; border-radius:5px; font-weight:600; }
  .btn:hover { opacity:0.8; }
  #chatScreen { display:flex; height:100%; }
  #sidebar { width:200px; background:#1b1b1b; display:flex; flex-direction:column; padding:5px; overflow-y:auto; }
  #sidebar .chatOption { display:flex; align-items:center; padding:5px; margin:2px 0; cursor:pointer; border-radius:5px; background:#2a2a2a; }
  #sidebar .chatOption:hover { background:#3a3a3a; }
  #sidebar .chatOption img { width:30px; height:30px; border-radius:50%; margin-right:10px; }
  #chatArea { flex:1; display:flex; flex-direction:column; background:#121212; }
  #messages { flex:1; overflow-y:auto; padding:10px; }
  .message { margin:5px 0; padding:5px; border-radius:5px; }
  .message:hover { background:#1f1f1f; }
  .message .username { font-weight:600; margin-right:5px; }
  .message .timestamp { font-size:0.7em; color:#aaa; margin-left:5px; }
  #inputArea { display:flex; padding:5px; background:#1b1b1b; }
  #inputArea input[type=text] { flex:1; padding:5px; border:none; border-radius:5px; margin-right:5px; }
  #inputArea button { padding:5px 10px; border:none; border-radius:5px; cursor:pointer; }
  .mention { color:#3399ff; font-weight:600; }
  .highlight { background:#d1a800; }
  a { color:#3399ff; text-decoration:none; }
  a:hover { text-decoration:underline; }
  #volumeControl { position:absolute; top:5px; right:5px; }
  #readMessagesBtn { position:absolute; top:5px; left:210px; }
</style>
</head>
<body>

<div id="loginScreen">
  <h2>HappeeChat2 Login</h2>
  <div id="accountsList"></div>
  <button class="btn" id="createAccountBtn">Create New Account</button>
</div>

<div id="chatScreen" style="display:none;">
  <div id="sidebar">
    <div class="chatOption" data-chat="public"><span>#</span> Public Chat <span id="publicUnread" style="margin-left:auto;"></span></div>
    <div id="dmList"></div>
  </div>
  <div id="chatArea">
    <div id="messages"></div>
    <div id="inputArea">
      <button id="addFileBtn">+</button>
      <input type="text" id="messageInput" placeholder="Type a message...">
      <button id="sendBtn">Send Message</button>
    </div>
  </div>
  <input type="range" min="0" max="1" step="0.01" id="volumeControl" title="Ping Volume">
  <button id="readMessagesBtn">Read Messages</button>
</div>

<audio id="pingSound" src="ping.mp3" preload="auto"></audio>
<input type="file" id="fileInput" style="display:none;">

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.1/firebase-app.js";
import { getDatabase, ref, set, get, child, push, onChildAdded, remove, update, query, orderByChild } from "https://www.gstatic.com/firebasejs/10.6.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDkpDlINFiUzR0PsFRcxxk-N2fhHLnpACI",
  authDomain: "hchat2-1d004.firebaseapp.com",
  databaseURL: "https://hchat2-1d004-default-rtdb.firebaseio.com",
  projectId: "hchat2-1d004",
  storageBucket: "hchat2-1d004.firebasestorage.app",
  messagingSenderId: "807685526215",
  appId: "1:807685526215:web:6b9042099ff0b464be24e2"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let currentUser = null;
let currentChat = 'public';
let unreadCounts = {};
const blacklist = ["badword1", "badword2"]; // replace with your words

const loginScreen = document.getElementById('loginScreen');
const chatScreen = document.getElementById('chatScreen');
const accountsList = document.getElementById('accountsList');
const dmList = document.getElementById('dmList');
const messagesDiv = document.getElementById('messages');
const messageInput = document.getElementById('messageInput');
const sendBtn = document.getElementById('sendBtn');
const addFileBtn = document.getElementById('addFileBtn');
const fileInput = document.getElementById('fileInput');
const pingSound = document.getElementById('pingSound');
const volumeControl = document.getElementById('volumeControl');
const readMessagesBtn = document.getElementById('readMessagesBtn');
const publicUnread = document.getElementById('publicUnread');

volumeControl.addEventListener('input', ()=>{ pingSound.volume = volumeControl.value; });

function sanitize(text) {
  let clean = text;
  blacklist.forEach(word => { clean = clean.replaceAll(new RegExp(word,'gi'), '*'.repeat(word.length)); });
  return clean;
}

function renderAccounts(accounts) {
  accountsList.innerHTML = '';
  Object.keys(accounts).forEach(name => {
    const div = document.createElement('div');
    div.className = 'account';
    const img = document.createElement('img');
    img.src = accounts[name].avatar || 'https://i1.sndcdn.com/avatars-V22Gw2FsnsI9xMuU-ihNrRA-t240x240.jpg';
    div.appendChild(img);
    div.appendChild(document.createTextNode(name));
    div.onclick = ()=>{ loginPrompt(name, accounts[name]); };
    accountsList.appendChild(div);
  });
}

async function loadAccounts() {
  const snapshot = await get(child(ref(db), 'users'));
  if(snapshot.exists()) renderAccounts(snapshot.val());
}

function loginPrompt(name, data){
  const pw = prompt("Enter password for " + name);
  if(pw === data.password){
    currentUser = {name, avatar:data.avatar, isAdmin:name==='100happee'};
    loginScreen.style.display = 'none';
    chatScreen.style.display = 'flex';
    loadChats();
  } else { alert("Wrong password"); }
}

document.getElementById('createAccountBtn').onclick = async ()=>{
  const username = prompt("Enter new username:");
  if(!username) return;
  const pw = prompt("Enter password:");
  if(!pw) return;
  const file = prompt("Enter avatar as Base64 (optional):") || '';
  const snapshot = await get(child(ref(db), 'users'));
  const users = snapshot.exists()?snapshot.val():{};
  if(users[username]){ alert("Username taken"); return; }
  await set(ref(db,'users/'+username),{password:pw,avatar:file,lastActive:Date.now()});
  loadAccounts();
};

function renderMessage(msg){
  const div = document.createElement('div');
  div.className = 'message';
  if(msg.mentions && msg.mentions.includes(currentUser.name)){ div.classList.add('highlight'); }
  const userSpan = document.createElement('span'); userSpan.className='username'; userSpan.textContent=msg.username;
  const tsSpan = document.createElement('span'); tsSpan.className='timestamp'; tsSpan.textContent='['+new Date(msg.timestamp).toLocaleString()+']';
  let content = sanitize(msg.text);
  // handle mentions and links
  content = content.replace(/@(\w+)/g, '<span class="mention">@$1</span>');
  content = content.replace(/https:\/\/[^\s]+/g, (link)=>`<a href="${link}" target="_blank">${link}</a>`);
  div.innerHTML += content;
  div.prepend(userSpan); div.appendChild(tsSpan);
  if(msg.file){
    let f;
    if(msg.fileType.startsWith('image/')){
      f=document.createElement('img'); f.src=msg.file; f.style.maxWidth='200px';
    } else if(msg.fileType.startsWith('video/')){
      f=document.createElement('video'); f.src=msg.file; f.controls=true; f.style.maxWidth='200px';
    } else if(msg.fileType.startsWith('audio/')){
      f=document.createElement('audio'); f.src=msg.file; f.controls=true;
    } else { f=document.createElement('a'); f.href=msg.file; f.download='file'; f.textContent='Download '+msg.fileName; }
    div.appendChild(f);
  }
  messagesDiv.appendChild(div);
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
  pingSound.play();
}

async function loadChats(){
  const msgsRef = ref(db,'messages/'+currentChat);
  onChildAdded(msgsRef, snapshot=>{ renderMessage(snapshot.val()); });
}

sendBtn.onclick = async ()=>{
  const text = messageInput.value.trim(); if(!text) return;
  let fileData = null, fileType='', fileName='';
  const msg = {username:currentUser.name,text,file:fileData,fileType,fileName,timestamp:Date.now(),mentions:[]};
  // detect mentions
  const mentionMatches = text.match(/@(\w+)/g);
  if(mentionMatches){ msg.mentions = mentionMatches.map(m=>m.substring(1)); }
  const newRef = push(ref(db,'messages/'+currentChat));
  await set(newRef,msg);
  messageInput.value='';
};

addFileBtn.onclick=()=>fileInput.click();
fileInput.onchange=()=>{
  const file = fileInput.files[0];
  if(file && file.size<=4*1024*1024){
    const reader = new FileReader();
    reader.onload = ()=>{ messageInput.value += '\n[File attached]'; };
    reader.readAsDataURL(file);
  } else alert("File too large or not selected");
};

loadAccounts();
</script>

</body>
</html>
